bit improved and more complex version supporting partial updates
